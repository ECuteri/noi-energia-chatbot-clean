---
alwaysApply: false
---

# Project Cursor Rules - WhatsApp Chatbot

## Project Overview
Building a production-ready WhatsApp chatbot with PostgreSQL database integration for chat storage and SQL database operations (SELECT, INSERT, UPDATE).

## Architecture Requirements
- **WhatsApp Integration**: Use official WhatsApp Business API or approved libraries
- **Database Layer**: Separate chat storage (PostgreSQL) from application data (SQL)
- **API Design**: RESTful endpoints for webhook handling and database operations
- **Message Processing**: Asynchronous processing for handling WhatsApp webhooks

## WhatsApp Integration Standards
- Handle all WhatsApp webhook events (messages, status updates, delivery receipts)
- Implement proper message validation and verification
- Support rich media messages (images, documents, audio)
- Handle WhatsApp rate limits and retry mechanisms
- Implement message threading and conversation context

## Database Architecture
```
chat_storage (PostgreSQL)
├── conversations
├── messages
├── participants
└── message_status

application_data (SQL)
├── users
├── products/services
└── business_logic_tables
```

## Data Management Rules
- **Chat Storage**: All WhatsApp conversations in PostgreSQL with proper indexing
- **Message Persistence**: Store messages before processing to prevent data loss
- **Transaction Safety**: Use database transactions for multi-table operations
- **Data Retention**: Implement chat archiving and cleanup policies
- **SQL Operations**: Use prepared statements and connection pooling

## Security & Privacy
- Encrypt sensitive chat data at rest
- Implement proper WhatsApp webhook signature verification
- Sanitize all database inputs to prevent SQL injection
- Respect WhatsApp's data privacy requirements
- Implement user consent tracking for data storage

## Message Flow Design
```
WhatsApp → Webhook → Validation → Chat Storage → Processing → Response → WhatsApp
                                      ↓
                              Application Database
```

## File Organization
```
src/
├── whatsapp/          # WhatsApp API integration
├── database/          # Database connections and queries
│   ├── chat/         # PostgreSQL chat operations
│   └── app/          # Application SQL operations
├── handlers/          # Webhook and message processors
├── services/          # Business logic
└── utils/            # Helpers and validators
```

## Environment Configuration
- Separate database connections for chat and application data
- WhatsApp API credentials and webhook URLs
- Database connection strings and pool configurations
- Message processing queue settings
- Rate limiting and retry configurations

## API Endpoints Structure
- `POST /webhook/whatsapp` - WhatsApp webhook receiver
- `GET/POST /api/chat/*` - Chat management endpoints
- `GET/POST/PUT /api/data/*` - Application data operations
- `GET /health` - Health checks for both databases

## Performance Considerations
- Index chat tables by user_id, timestamp, and conversation_id
- Use connection pooling for both databases
- Implement message batching for bulk operations
- Cache frequently accessed application data
- Async processing for non-critical operations

## Testing Requirements
- Mock WhatsApp webhook payloads for testing
- Database integration tests with test databases
- Message flow end-to-end testing
- SQL injection and security testing
- Load testing for webhook handling

## Monitoring & Alerts
- Track message delivery success rates
- Monitor database connection health
- Alert on webhook processing failures
- Log chat message volumes and patterns
- Database performance metrics

## Data Models
- Normalize chat data with proper foreign keys
- Use UUIDs for message and conversation IDs
- Include metadata fields (timestamps, status, sender_type)
- Version control for database schema changes
- Implement soft deletes for chat history# Project Cursor Rules - WhatsApp Chatbot

## Project Overview
Building a production-ready WhatsApp chatbot with PostgreSQL database integration for chat storage and SQL database operations (SELECT, INSERT, UPDATE).

## Architecture Requirements
- **WhatsApp Integration**: Use official WhatsApp Business API or approved libraries
- **Database Layer**: Separate chat storage (PostgreSQL) from application data (SQL)
- **API Design**: RESTful endpoints for webhook handling and database operations
- **Message Processing**: Asynchronous processing for handling WhatsApp webhooks

## WhatsApp Integration Standards
- Handle all WhatsApp webhook events (messages, status updates, delivery receipts)
- Implement proper message validation and verification
- Support rich media messages (images, documents, audio)
- Handle WhatsApp rate limits and retry mechanisms
- Implement message threading and conversation context

## Database Architecture
```
chat_storage (PostgreSQL)
├── conversations
├── messages
├── participants
└── message_status

application_data (SQL)
├── users
├── products/services
└── business_logic_tables
```

## Data Management Rules
- **Chat Storage**: All WhatsApp conversations in PostgreSQL with proper indexing
- **Message Persistence**: Store messages before processing to prevent data loss
- **Transaction Safety**: Use database transactions for multi-table operations
- **Data Retention**: Implement chat archiving and cleanup policies
- **SQL Operations**: Use prepared statements and connection pooling

## Security & Privacy
- Encrypt sensitive chat data at rest
- Implement proper WhatsApp webhook signature verification
- Sanitize all database inputs to prevent SQL injection
- Respect WhatsApp's data privacy requirements
- Implement user consent tracking for data storage

## Message Flow Design
```
WhatsApp → Webhook → Validation → Chat Storage → Processing → Response → WhatsApp
                                      ↓
                              Application Database
```

## File Organization
```
src/
├── whatsapp/          # WhatsApp API integration
├── database/          # Database connections and queries
│   ├── chat/         # PostgreSQL chat operations
│   └── app/          # Application SQL operations
├── handlers/          # Webhook and message processors
├── services/          # Business logic
└── utils/            # Helpers and validators
```

## Environment Configuration
- Separate database connections for chat and application data
- WhatsApp API credentials and webhook URLs
- Database connection strings and pool configurations
- Message processing queue settings
- Rate limiting and retry configurations

## API Endpoints Structure
- `POST /webhook/whatsapp` - WhatsApp webhook receiver
- `GET/POST /api/chat/*` - Chat management endpoints
- `GET/POST/PUT /api/data/*` - Application data operations
- `GET /health` - Health checks for both databases

## Performance Considerations
- Index chat tables by user_id, timestamp, and conversation_id
- Use connection pooling for both databases
- Implement message batching for bulk operations
- Cache frequently accessed application data
- Async processing for non-critical operations

## Testing Requirements
- Mock WhatsApp webhook payloads for testing
- Database integration tests with test databases
- Message flow end-to-end testing
- SQL injection and security testing
- Load testing for webhook handling

## Monitoring & Alerts
- Track message delivery success rates
- Monitor database connection health
- Alert on webhook processing failures
- Log chat message volumes and patterns
- Database performance metrics

## Data Models
- Normalize chat data with proper foreign keys
- Use UUIDs for message and conversation IDs
- Include metadata fields (timestamps, status, sender_type)
- Version control for database schema changes
- Implement soft deletes for chat history
